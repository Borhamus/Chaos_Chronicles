{% extends "base_generic.html" %}

{% block title %} <title>Creación del Deck</title> {% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>{% if deck %}Editar Deck{% else %}Crear Nuevo Deck{% endif %}</h2>
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <div id="deck-container" class="container mt-4 border p-3">
            <h4>Deck (0/21)</h4>
            <div id="deck-cards" class="row"></div>
        </div>
        <div id="available-cards" class="container mt-4">
            <h4>Cartas Disponibles</h4>
            <div class="row">
                {% for carta in cartas %}
                <div class="col-md-3">
                    <div class="card">
                        <img src="/media/{{ carta.Imagen }}" class="card-img-top" alt="{{ carta.Nombre }}">
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ carta.Nombre }}</h5>
                            <p class="card-text">Costo: {{ carta.Costo }}</p>
                            <button type="button" class="btn btn-success add-to-deck" data-carta-id="{{ carta.id }}" data-carta-nombre="{{ carta.Nombre }}" data-carta-costo="{{ carta.Costo }}">+</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Guardar</button>
    </form>
    <a href="{% url 'deck_list' %}" class="btn btn-secondary mt-3">Volver a la Lista de Decks</a>
</div>

<!-- Modal para seleccionar el tipo de carta -->
<div class="modal fade" id="selectTypeModal" tabindex="-1" role="dialog" aria-labelledby="selectTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectTypeModalLabel">Seleccionar Tipo de Carta</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <select id="card-type-select" class="form-control">
                    <option value="tr">Triángulo</option>
                    <option value="cu">Cuadrado</option>
                    <option value="ci">Círculo</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="add-card-btn">Agregar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const deckContainer = document.getElementById('deck-cards');
        const availableCards = document.querySelectorAll('.add-to-deck');
        let puntosRestantes = 100;
        const puntosElement = document.createElement('p');
        puntosElement.textContent = `Puntos restantes: ${puntosRestantes}`;
        document.querySelector('.container').insertBefore(puntosElement, document.querySelector('#deck-container'));

        availableCards.forEach(button => {
            button.addEventListener('click', function() {
                const cartaId = this.dataset.cartaId;
                const cartaNombre = this.dataset.cartaNombre;
                const cartaCosto = parseInt(this.dataset.cartaCosto);
                
                if (puntosRestantes >= cartaCosto) {
                    // Mostrar el modal para seleccionar el tipo de carta
                    $('#selectTypeModal').data('carta-id', cartaId).data('carta-nombre', cartaNombre).data('carta-costo', cartaCosto).modal('show');
                } else {
                    alert('No tienes suficientes puntos restantes para agregar esta carta.');
                }
            });
        });

        document.getElementById('add-card-btn').addEventListener('click', function() {
            const cartaId = $('#selectTypeModal').data('carta-id');
            const cartaNombre = $('#selectTypeModal').data('carta-nombre');
            const cartaCosto = $('#selectTypeModal').data('carta-costo');
            const cartaTipo = document.getElementById('card-type-select').value;

            // Deducir el costo de los puntos restantes
            puntosRestantes -= cartaCosto;
            puntosElement.textContent = `Puntos restantes: ${puntosRestantes}`;

            // Agregar la carta al contenedor del deck
            const cartaElement = document.createElement('div');
            cartaElement.classList.add('col-md-3');
            cartaElement.innerHTML = `
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">${cartaNombre} (${cartaTipo})</h5>
                        <p class="card-text">Costo: ${cartaCosto}</p>
                    </div>
                </div>
            `;
            deckContainer.appendChild(cartaElement);

            // Cerrar el modal
            $('#selectTypeModal').modal('hide');
        });
    });
</script>
{% endblock %}
